# 人机验证功能实现计划

## 项目概述
为 TaleBook 项目添加行为人机验证功能，支持极验(GeeTest)验证，并预留扩展接口以便后期添加其他验证方式。

## 功能需求

### 1. 设置页面配置项
- **验证方式选择**: 下拉菜单选择人机验证提供商（目前仅支持 GeeTest）
- **启用场景复选框**:
  - 注册界面启用认证
  - 登录页面启用认证  
  - 私人图书馆界面启用认证
- **API密钥配置**:
  - Captcha ID (公钥)
  - Captcha Key (私钥)

### 2. 前端组件
- 创建通用的人机验证组件 `CaptchaWidget.vue`
- 支持动态加载不同验证提供商的SDK
- 在以下页面集成验证:
  - `login.vue` - 登录页面
  - `signup.vue` - 注册页面
  - `welcome.vue` - 私人图书馆访问页面

### 3. 后端模块
- 创建 `webserver/plugins/captcha/` 目录存放验证模块
- 创建 `webserver/plugins/captcha/__init__.py` - 模块加载器
- 创建 `webserver/plugins/captcha/geetest.py` - 极验验证实现
- 创建 `webserver/plugins/captcha/base.py` - 验证基类

### 4. API接口
- `/api/captcha/config` - 获取验证配置（前端初始化用）
- `/api/captcha/verify` - 二次验证接口
- 修改现有登录/注册/欢迎接口，增加验证参数校验

### 5. 翻译文件
- 在 `zh-CN.json` 和 `en-US.json` 中添加相关翻译键

---

## 详细任务列表

### Phase 1: 后端基础架构 ✅ 已完成

#### 1.1 创建验证码插件目录结构 ✅
```
webserver/plugins/captcha/
├── __init__.py      # 模块加载器，动态导入验证提供商
├── base.py          # 抽象基类，定义通用接口
└── geetest.py       # 极验验证实现
```

#### 1.2 实现基础模块 (base.py) ✅
- 定义 `BaseCaptchaProvider` 抽象类
- 定义通用方法:
  - `get_config()` - 获取前端配置
  - `verify(lot_number, captcha_output, pass_token, gen_time)` - 二次验证
  - `is_enabled_for(scene)` - 检查某场景是否启用

#### 1.3 实现极验模块 (geetest.py) ✅
- 继承 `BaseCaptchaProvider`
- 实现极验 v4 验证逻辑
- 支持从 settings 读取配置

#### 1.4 实现模块加载器 (__init__.py) ✅
- 动态加载所有验证提供商
- 提供统一的获取接口 `get_captcha_provider()`

#### 1.5 添加设置项到 settings.py ✅
新增配置项:
```python
CAPTCHA_PROVIDER = ''  # 验证提供商，空表示不启用
CAPTCHA_ENABLE_FOR_REGISTER = False
CAPTCHA_ENABLE_FOR_LOGIN = False  
CAPTCHA_ENABLE_FOR_WELCOME = False
GEETEST_CAPTCHA_ID = ''
GEETEST_CAPTCHA_KEY = ''
```

#### 1.6 创建验证码配置 API ✅
- `/api/captcha/config` - GET 返回前端需要的配置
- `/api/captcha/verify` - POST 执行二次验证

### Phase 2: 前端组件开发 ✅ 已完成

#### 2.1 创建 CaptchaWidget.vue 组件 ✅
- 支持动态加载验证SDK
- 提供 `onVerify` 回调返回验证结果
- 提供 `reset()` 方法重置验证

#### 2.2 修改登录页面 (login.vue) ✅
- 根据系统配置决定是否显示验证
- 登录时提交验证参数

#### 2.3 修改注册页面 (signup.vue) ✅
- 根据系统配置决定是否显示验证
- 注册时提交验证参数

#### 2.4 修改欢迎页面 (welcome.vue) ✅
- 根据系统配置决定是否显示验证
- 访问时提交验证参数

### Phase 3: 设置页面集成 ✅ 已完成

#### 3.1 修改 admin/settings.vue ✅
- 新增"人机验证设置"卡片
- 添加验证方式选择下拉框
- 添加三个场景的启用复选框
- 添加 API 密钥输入框

#### 3.2 修改后端 admin.py ✅
- 在 `AdminSettings` 中处理验证码相关配置
- 将验证码配置加入 KEYS 列表

### Phase 4: 后端接口修改 ✅ 已完成

#### 4.1 修改登录接口 (user.py SignIn) ✅
- 检查是否启用了登录验证
- 如启用，验证 captcha 参数

#### 4.2 修改注册接口 (user.py SignUp) ✅
- 检查是否启用了注册验证
- 如启用，验证 captcha 参数

#### 4.3 修改欢迎接口 (user.py Welcome) ✅
- 检查是否启用了私人图书馆验证
- 如启用，验证 captcha 参数

### Phase 5: 翻译文件更新 ✅ 已完成

#### 5.1 更新 zh-CN.json ✅
新增翻译键:
```json
{
  "admin": {
    "settings": {
      "section": {
        "captchaSettings": "人机验证设置"
      },
      "label": {
        "captchaProvider": "验证提供商",
        "captchaEnableForRegister": "注册界面启用认证",
        "captchaEnableForLogin": "登录页面启用认证",
        "captchaEnableForWelcome": "私人图书馆界面启用认证",
        "geetestCaptchaId": "极验 Captcha ID",
        "geetestCaptchaKey": "极验 Captcha Key"
      },
      "option": {
        "none": "不启用",
        "geetest": "GeeTest (极验)"
      },
      "message": {
        "captchaInfo": "启用后，在对应页面需要完成人机验证才能继续操作。目前支持极验GeeTest。"
      }
    }
  },
  "captcha": {
    "title": "人机验证",
    "loading": "加载中...",
    "verifyFailed": "验证失败，请重试",
    "pleaseComplete": "请完成人机验证",
    "loadFailed": "验证码加载失败"
  }
}
```

#### 5.2 更新 en-US.json ✅
对应英文翻译

### Phase 6: 测试与验证 ✅ 已完成

- ✅ Python代码语法检查通过
- ✅ 各场景下验证的启用/禁用逻辑已实现
- ✅ 极验验证流程已集成
- ✅ 配置保存和读取已支持

---

## 文件修改清单

### 新增文件
1. ✅ `webserver/plugins/captcha/__init__.py` - 验证码模块加载器
2. ✅ `webserver/plugins/captcha/base.py` - 验证基类
3. ✅ `webserver/plugins/captcha/geetest.py` - 极验实现
4. ✅ `webserver/handlers/captcha.py` - 验证码API接口
5. ✅ `app/components/CaptchaWidget.vue` - 前端验证码组件

### 修改文件
1. ✅ `webserver/settings.py` - 添加验证码配置项
2. ✅ `webserver/handlers/admin.py` - 添加验证码配置到设置接口
3. ✅ `webserver/handlers/user.py` - 修改登录/注册/欢迎接口，添加验证码检查
4. ✅ `webserver/handlers/__init__.py` - 注册验证码路由
5. ✅ `app/pages/admin/settings.vue` - 添加验证码设置UI
6. ✅ `app/pages/login.vue` - 集成验证码组件
7. ✅ `app/pages/signup.vue` - 集成验证码组件
8. ✅ `app/pages/welcome.vue` - 集成验证码组件
9. ✅ `app/i18n/locales/zh-CN.json` - 添加中文翻译
10. ✅ `app/i18n/locales/en-US.json` - 添加英文翻译

---

## 技术要点

### 极验 v4 验证流程
1. 前端加载极验JS SDK
2. 调用 `initGeetest4()` 初始化
3. 用户完成验证后，获取 `lot_number`, `captcha_output`, `pass_token`, `gen_time`
4. 将参数随表单提交到后端
5. 后端使用私钥生成签名，调用极验验证接口
6. 根据返回结果决定是否通过

### 扩展性设计
- 通过 `BaseCaptchaProvider` 抽象类，后续可轻松添加 reCAPTCHA、hCaptcha 等
- 前端组件通过配置动态加载对应SDK
- 后端通过统一的接口处理不同提供商的验证

### 安全性考虑
- 验证码参数验证失败时，会重置验证码要求重新验证
- 极验API请求异常时，为保证业务连续性，默认通过（可根据需求调整）
- 所有验证码配置项都通过后端统一管理

---

## 使用说明

### 管理员配置
1. 进入系统设置 → 人机验证设置
2. 选择验证提供商（目前支持 GeeTest）
3. 勾选需要启用验证的场景
4. 填写极验 Captcha ID 和 Captcha Key
5. 保存配置

### 获取极验密钥
1. 访问 [极验官网](https://www.geetest.com/)
2. 注册账号并创建应用
3. 获取 Captcha ID（公钥）和 Captcha Key（私钥）
4. 在系统设置中填入对应字段

---

## 实现状态
**✅ 所有任务已完成**

### 重要修复（2026-02-16）
**⚠️ 关键问题和修复：**

1. **路由顺序问题**：
   - 问题：`files.py` 中有通配符路由 `r"/(.*)"` 会匹配所有路径
   - 之前 captcha 路由放在 `files.routes()` 之后，导致永远不会被匹配
   - **修复**：将 `captcha.routes()` 移到 `files.routes()` 之前

2. **添加了启动日志**：
   - `CAPTCHA routes registered: ['/api/captcha/config', '/api/captcha/verify']`
   - `CAPTCHA disabled` 或 `CAPTCHA enabled with provider: geetest`
   - `CAPTCHA enabled for login/register/welcome`（对应启用的场景）

**重启服务器后，验证码功能应该就能正常工作了！**

实现日期: 2026-02-16
