çœ‹äº†ä½ çš„ä»£ç ï¼Œé—®é¢˜å‡ºåœ¨**cookieçš„æœ‰æ•ˆæœŸè®¾ç½®**ä¸Šã€‚ä½ è™½ç„¶è®¾ç½®äº†1åˆ†é’Ÿè¿‡æœŸï¼Œä½†å®é™…éªŒè¯é€»è¾‘å­˜åœ¨å‡ ä¸ªå…³é”®é—®é¢˜ï¼š

## ğŸ” é—®é¢˜åˆ†æ

### 1. **Cookieæœ‰æ•ˆæœŸè®¡ç®—é”™è¯¯**
```python
expires_days=1/24/60  # 1åˆ†é’Ÿ
```
è¿™ä¸ªè®¡ç®—ç»“æœæ˜¯ **0.000694å¤©** â‰ˆ 1åˆ†é’Ÿï¼Œä½†`expires_days`æ˜¯**æµ®ç‚¹æ•°å¤©**ï¼Œè¿™ä¸ªè®¡ç®—æ˜¯æ­£ç¡®çš„ã€‚é—®é¢˜ä¸åœ¨è¿™é‡Œã€‚

### 2. **çœŸæ­£çš„é—®é¢˜ - éªŒè¯æ—¶æœº**
é—®é¢˜å¯èƒ½å‡ºç°åœ¨è¿™é‡Œï¼š

```python
captcha_answer = self.get_secure_cookie("captcha_answer")

if not captcha_answer:
    return {"err": "captcha.expired", "msg": _("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°")}
```

å½“éªŒè¯æ—¶å‘ç°`captcha_answer`ä¸ºç©ºï¼Œå°±è¿”å›è¿‡æœŸã€‚ä½†ä¸ºä»€ä¹ˆä¼šä¸ºç©ºï¼Ÿ

### 3. **å¯èƒ½çš„åŸå› **

#### **åŸå› 1ï¼šæµè§ˆå™¨Cookieç­–ç•¥**
å¦‚æœä½¿ç”¨çš„æ˜¯æœ¬åœ°æ–‡ä»¶è®¿é—®ï¼ˆ`file://`åè®®ï¼‰æˆ–è·¨åŸŸè¯·æ±‚ï¼Œsecure cookieå¯èƒ½æ— æ³•æ­£å¸¸å†™å…¥/è¯»å–ã€‚

**è§£å†³æ–¹æ¡ˆ**ï¼šç¡®ä¿åœ¨HTTP/HTTPSç¯å¢ƒä¸‹æµ‹è¯•ã€‚

#### **åŸå› 2ï¼šCookieè¢«æå‰æ¸…é™¤**
æ³¨æ„ä½ çš„ä»£ç åœ¨éªŒè¯æˆåŠŸå‰å°±æ¸…é™¤äº†cookieï¼š
```python
# æ¸…é™¤å·²ä½¿ç”¨çš„éªŒè¯ç 
self.clear_cookie("captcha_answer")
```

å¦‚æœéªŒè¯å¤±è´¥ï¼Œä½†cookieå·²è¢«æ¸…é™¤ï¼Œä¸‹æ¬¡é‡è¯•å°±ä¼šæ˜¾ç¤ºè¿‡æœŸã€‚

#### **åŸå› 3ï¼šéªŒè¯ç ç”Ÿæˆå’ŒéªŒè¯ä½¿ç”¨ä¸åŒå®ä¾‹**
å¦‚æœå¤šæ¬¡è°ƒç”¨ç”Ÿæˆæ¥å£ï¼Œåé¢çš„è¯·æ±‚ä¼šè¦†ç›–å‰é¢çš„cookieã€‚

## ğŸ› ï¸ ä¿®å¤æ–¹æ¡ˆ

### æ–¹æ¡ˆ1ï¼šä¿®æ”¹éªŒè¯é€»è¾‘ï¼Œä¼˜åŒ–cookieå¤„ç†
```python
class CaptchaImageHandler(CaptchaBaseHandler):
    @js
    def get(self):
        """ç”Ÿæˆæ–°çš„å›¾å½¢éªŒè¯ç """
        provider = ImageCaptchaProvider(CONF)
        result = provider.generate()
        
        # ä½¿ç”¨æ›´é•¿çš„è¿‡æœŸæ—¶é—´ï¼Œå¹¶åœ¨éªŒè¯æ—¶å•ç‹¬åˆ¤æ–­
        import datetime
        expires = datetime.datetime.utcnow() + datetime.timedelta(minutes=1)
        
        self.set_secure_cookie(
            "captcha_answer", 
            result["code"],
            expires=expires  # ä½¿ç”¨expiresè€Œä¸æ˜¯expires_days
        )
        
        # åŒæ—¶è®¾ç½®ä¸€ä¸ªæ—¶é—´æˆ³ï¼Œç”¨äºç²¾ç¡®åˆ¤æ–­
        self.set_secure_cookie(
            "captcha_generate_time",
            str(datetime.datetime.utcnow().timestamp()),
            expires=expires
        )
        
        return {
            "err": "ok",
            "captcha_id": result["captcha_id"],
            "image": result["image"]
        }


class CaptchaVerifyHandler(CaptchaBaseHandler):
    @js
    def post(self):
        """æ‰§è¡ŒéªŒè¯ç éªŒè¯"""
        provider_name = self.get_argument("provider", "")
        
        if provider_name == "image":
            captcha_code = self.get_argument("captcha_code", "")
            captcha_answer = self.get_secure_cookie("captcha_answer")
            generate_time = self.get_secure_cookie("captcha_generate_time")
            
            # æ£€æŸ¥æ˜¯å¦å­˜åœ¨éªŒè¯ç 
            if not captcha_answer or not generate_time:
                return {"err": "captcha.expired", "msg": _("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°")}
            
            # æ£€æŸ¥æ˜¯å¦è¿‡æœŸï¼ˆåŒé‡éªŒè¯ï¼‰
            import datetime
            try:
                gen_time = datetime.datetime.fromtimestamp(float(generate_time.decode('utf-8')))
                now = datetime.datetime.utcnow()
                if (now - gen_time).total_seconds() > 60:  # è¶…è¿‡60ç§’
                    self.clear_cookie("captcha_answer")
                    self.clear_cookie("captcha_generate_time")
                    return {"err": "captcha.expired", "msg": _("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°")}
            except:
                pass  # æ—¶é—´è§£æå¤±è´¥ï¼Œè®©åç»­éªŒè¯å†³å®š
            
            # å…ˆéªŒè¯ï¼Œåæ¸…é™¤
            result = captcha_module.verify_captcha(
                CONF,
                captcha_code=captcha_code,
                captcha_answer=captcha_answer.decode('utf-8')
            )
            
            # éªŒè¯æˆåŠŸåæ¸…é™¤ï¼Œå¤±è´¥ä¸æ¸…é™¤ï¼ˆå…è®¸é‡è¯•ï¼‰
            if result:
                self.clear_cookie("captcha_answer")
                self.clear_cookie("captcha_generate_time")
                return {"err": "ok", "msg": _("éªŒè¯é€šè¿‡")}
            else:
                return {"err": "captcha.invalid", "msg": _("éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•")}
        
        # ... å…¶ä»–éªŒè¯é€»è¾‘
```

### æ–¹æ¡ˆ2ï¼šç®€åŒ–æ–¹æ¡ˆ - ä½¿ç”¨sessionå­˜å‚¨
å¦‚æœé¡¹ç›®ä½¿ç”¨äº†sessionï¼Œå¯ä»¥è€ƒè™‘æ”¹ç”¨sessionå­˜å‚¨ï¼š

```python
class CaptchaImageHandler(CaptchaBaseHandler):
    @js
    def get(self):
        """ç”Ÿæˆæ–°çš„å›¾å½¢éªŒè¯ç """
        provider = ImageCaptchaProvider(CONF)
        result = provider.generate()
        
        # å­˜å‚¨åœ¨sessionä¸­
        self.session['captcha'] = {
            'code': result["code"],
            'generate_time': datetime.datetime.utcnow().timestamp()
        }
        
        return {
            "err": "ok",
            "captcha_id": result["captcha_id"],
            "image": result["image"]
        }


class CaptchaVerifyHandler(CaptchaBaseHandler):
    @js
    def post(self):
        """æ‰§è¡ŒéªŒè¯ç éªŒè¯"""
        provider_name = self.get_argument("provider", "")
        
        if provider_name == "image":
            captcha_code = self.get_argument("captcha_code", "")
            captcha_data = self.session.get('captcha')
            
            if not captcha_data:
                return {"err": "captcha.expired", "msg": _("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°")}
            
            # æ£€æŸ¥æ˜¯å¦è¿‡æœŸ
            now = datetime.datetime.utcnow().timestamp()
            if now - captcha_data['generate_time'] > 60:  # 60ç§’è¿‡æœŸ
                del self.session['captcha']
                return {"err": "captcha.expired", "msg": _("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°")}
            
            # éªŒè¯
            result = captcha_module.verify_captcha(
                CONF,
                captcha_code=captcha_code,
                captcha_answer=captcha_data['code']
            )
            
            if result:
                del self.session['captcha']
                return {"err": "ok", "msg": _("éªŒè¯é€šè¿‡")}
            else:
                return {"err": "captcha.invalid", "msg": _("éªŒè¯ç é”™è¯¯ï¼Œè¯·é‡è¯•")}
```

### æ–¹æ¡ˆ3ï¼šè°ƒè¯•æ–¹æ¡ˆ
åœ¨ç°æœ‰ä»£ç ä¸­æ·»åŠ æ—¥å¿—ï¼Œå¸®åŠ©å®šä½é—®é¢˜ï¼š

```python
class CaptchaVerifyHandler(CaptchaBaseHandler):
    @js
    def post(self):
        """æ‰§è¡ŒéªŒè¯ç éªŒè¯"""
        provider_name = self.get_argument("provider", "")
        
        if provider_name == "image":
            captcha_code = self.get_argument("captcha_code", "")
            captcha_answer = self.get_secure_cookie("captcha_answer")
            
            # æ·»åŠ è°ƒè¯•æ—¥å¿—
            logging.debug(f"éªŒè¯ç éªŒè¯ - ç”¨æˆ·è¾“å…¥: {captcha_code}")
            logging.debug(f"Cookieä¸­çš„ç­”æ¡ˆ: {captcha_answer}")
            logging.debug(f"æ‰€æœ‰cookies: {self.request.cookies}")
            
            if not captcha_answer:
                return {"err": "captcha.expired", "msg": _("éªŒè¯ç å·²è¿‡æœŸï¼Œè¯·åˆ·æ–°")}
            
            # ... åç»­ä»£ç 
```

## ğŸ“ å»ºè®®

1. **å…ˆæ·»åŠ è°ƒè¯•æ—¥å¿—**ï¼ŒæŸ¥çœ‹cookieæ˜¯å¦çœŸçš„å­˜åœ¨
2. **æ£€æŸ¥æµè§ˆå™¨è®¾ç½®**ï¼Œç¡®ä¿æ²¡æœ‰ç¦ç”¨cookie
3. **è€ƒè™‘ä½¿ç”¨sessionå­˜å‚¨**ï¼Œæ›´ç¨³å®šå¯é 
4. **éªŒè¯æˆåŠŸåæ‰æ¸…é™¤**ï¼Œé¿å…éªŒè¯å¤±è´¥åæ— æ³•é‡è¯•

æœ€å¯èƒ½çš„åŸå› æ˜¯**éªŒè¯é€»è¾‘é¡ºåºé—®é¢˜**æˆ–**æµè§ˆå™¨cookieç­–ç•¥**å¯¼è‡´ã€‚å…ˆæ·»åŠ æ—¥å¿—çœ‹çœ‹å…·ä½“æ˜¯å“ªä¸ªç¯èŠ‚å‡ºçš„é—®é¢˜ã€‚