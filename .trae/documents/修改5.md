Python 项目从 Flake8、Black 迁移至 Ruff 指南
2024-05-25  软件开发
文章目录
本文主旨与目标读者
为什么要用Ruff？
迁移任务清单
一、更新 pyproject.toml
Ruff Linter、Formatter 设定
二、更新 VS Code 套件
三、更新 pre-commit 设定
四、统一格式化
补充：pyupgrade 真是棒！
from Pixabay
from Pixabay

上个月，我将工作上几个项目的 Python linter、formatter，从原本的 Flake8、isort、Black Formatter 迁移至 Ruff。

本来以为很简单，应该半小时就可以搞定。 不料细节比想象中的多，前前后后还是花了近 2 小时。

可能我比较龟毛吧！

正因耗费的时间有点多，所以写下这篇懒人包教学，作为读者迁移时的参考。

本文主旨与目标读者
这篇文章是写给，目前正使用上述 Flake8、isort、Black Formatter 作为格式化工具，并打算迁移至 Ruff 的 Python 开发者。

受众就是〈VS Code 设定 Python Linter、Formatter 教学〉中描述的那样。 在项目中使用上述工具，也安装了相关的 VS Code 套件，设定好 pre-commit hook，以及使用 pyproject.toml 作为这些工具的配置文件。

而本文的目标，就是让项目的linter、formatter，最终都统一使用Ruff。

系列：Python Ruff 教学
系列文章列表（连载中）
为什么要用Ruff？
在系列第一篇，即《Python开发：Ruff Linter、Formatter 介绍 + 设定教学》中，我阐述了使用Ruff的两大理由。

在工作上用了Ruff近2个月后，我觉得这两个理由都很真实。 而且，速度带来的差异与感受，比我想象的更多！

除此之外，还有一个我之前没想到的优点——避免冲突。

工具间的行为冲突
我们知道，linter 与 formatter 如果进行客制化设定，那两者对于格式的要求可能会发生不一致，这在设定上需要留意。

比如最常见的单行最大字符上限。 如果在 Flake8 从 79 字符改成 100，那 isort 和 Black 也要跟着设定才行！

尤其 isort 和 Black 都是格式化器，两者都有「格式化代码」的能力，如果设置不一致，会带来一定的困扰。

所以 isort 才会有以下这个常见设定：

[tool.isort]
profile = "black"
为的就是和 Black 达成一致。

而這些潛在的「衝突」議題，在統一使用 Ruff 後，將不復存在。

遷移任務清單
我們先看一下，遷移至 Ruff 需要完成的任務有哪些：

更新 pyproject.toml：新增、移除套件。更新工具設定檔內容。
更新 VS Code 套件、設定格式化行為。
更新 pre-commit 設定。
統一格式化專案所有程式碼。
以下說明其中的重點。

一、更新 pyproject.toml
這是所有步驟中，比較需要費心的部分。

首先是移除舊套件，並新增 Ruff。

在此假設你也是用 Poetry 來管理虛擬環境，所以我們可以直接修改 pyproject.toml 的 Poetry 設定部分：

[tool.poetry.group.dev.dependencies]
ruff = "0.4.5"  # 版本必須固定，與 pre-commit 一致
# 移除 flake8 = "6.1.0"
# 移除 black = "23.10.1"
# 移除 isort = "5.12.0"
修改完成後，記得執行和。poetry lockpoetry install

一般使用 Poetry，套件版本的指定我們會採運算子，讓套件有一個自動升級範圍，增加相容性。

但 linter、formatter 這類工具，因為還要配合 pre-commit hook，所以我幾乎都是固定版本、手動更新——尤其 Ruff 更新版本就要重新建立 pre-commit hook 的虛擬環境，過程相對耗時。

Ruff Linter、Formatter 設定
接下來是重頭戲——在 pyproject.toml 中設定 Ruff 行為。我們先看結果：

[project]
requires-python = ">=3.11" #影響 pyupgrade 檢查與自動修正的版本

[tool.ruff]  # https://docs.astral.sh/ruff/settings/#top-level
line-length = 100
exclude = ["**/migrations/", "**/manage.py"]

[tool.ruff.lint]  # https://docs.astral.sh/ruff/settings/#lint
select = [
    "E",  # pycodestyle errors
    "W",  # pycodestyle warnings
    "F",  # pyflakes
    "I",  # isort
    "UP",  # pyupgrade
]
ignore = [
    "E402",  # module level import not at top of file
]

[tool.ruff.format]  # https://docs.astral.sh/ruff/settings/#format
quote-style = "double"  # 引號風格，雙引號是預設值，這裡只是明示這個設定
为了教学说明与维护方便，我加上了大量注解。

我强烈建议你在工作项目中，也要为这些设定适度加入注解——毕竟不是每个人都熟悉Ruff。 而且，Ruff 可设定的项目众多，久了自己可能也会忘记。

大部分的设定，我们在第一篇都已提过，不再重复。

以下补充一些值得留意的点。

一、必须明确区分 Linter 和 Formatter 设定
从Ruff 0.2版开始，对于section名称（即、等）有比较严格的要求。 可以参考这个 PR。tool.rufftool.ruff.format

简言之，共享设定放。 如果是 linter 专用的设定就要放，Ruff Formatter 的设定则要放。tool.rufftool.ruff.linttool.ruff.format

不像以前那么宽松。

设定不合法时，会有错误提醒，留意一下即可。

二、requires-python 设定
这个 key 是让你指定项目的 Python 版本，有两种表达方式。 第一篇我们用的是这种，本文用的是第二种。

官方文件推荐使用第二种：

If you’re already using a  file, we recommend  instead, as it’s based on Python packaging standards, and will be respected by other tools.pyproject.tomlproject.requires-python

我们从善如流。

三、quote-style
最后不忘提醒，Ruff formatter 的 quote-style 设定，将会使整个项目的「引号」风格趋于统一（PEP 8 惯例除外，比如 docstring）。

换句话说，有些人习惯用单引号，有些则是双引号，迁移后将会统一。

这对任何项目都是不小的变动，迁移前需要认真考虑，尤其是团队对于要用哪一种风格，是否已达成初步的一致。

比如我自己是单引号支持者，但是在工作中，为了提高大家采用新工具的意愿，我愿意稍作妥协。 所以上面的例子是双引号。

二、更新 VS Code 套件
这部分就很简单了。

移除旧套件，安装新套件。 但如果你还有其他项目需要使用 Flake8 等工具，那也不能轻易移除。 此时可以参考前一篇的「在工作区停用」。

以免不同套件相互干扰。

至于 Python 部分的 VS Code 设定，可直接参考前篇。

三、更新 pre-commit 设定
这部分比以前简洁很多：

repos:
  - repo: https://github.com/astral-sh/ruff-pre-commit
    rev: v0.4.5
    hooks:
      - id: ruff
        args: [ --fix ]  # 啟用ruff --fix自動修復，會有類似format的效果
      - id: ruff-format
毕竟以前要设定三个工具，如今只剩下一个。

四、统一格式化
统一格式化，而不是一边开发一边格式化，以免造成功能更新与格式化更新混淆，导致 code review 时的大量视觉干扰。

怎么做呢？ 回到命令列以指令作。

在工程根目录使用下列命令 ：

1
ruff format
就这么简单，0.1.7 版以后，它实际上有一个预设参数是「」，也就是整个目录。.

详情可参考官方文件。

注意，有些档案没必要格式化，比如 Django 项目 migrations 目录下的数据库迁移文件，可以在 pyproject.toml 中设定。exclude

补充：pyupgrade 真是棒！
Ruff 整合了 pyupgrade，让我第一次认识到这个强大的工具。

我强烈建议，一定要开启 pyupgrade 功能！ 让项目中的 Python 语法维持更高程度的一致性。

毕竟，在团队协作中，「一致性」有时比惯例更加重要。

例示：修正 type hints 语法
比如 Python type hints 中，关于 Optional 的写法，3.9 以前会这样写：

1
2
3
4
from typing import Optional

def foo(arg: Optional[int]):
    ...
Optional 本身是 Union 在特定情况下的别名，但它常常让人感到困惑。

而在 Python 3.10 之后，上述写法可以改为：

1
2
def foo(arg: int | None):
    ...
后者显然更加简洁且直观。 （让你一望即知，参数型别不是 int 就是 None）

不过话说回来，这个例子并不是一个好的 type hints 示范，理由可参考这篇〈Python Type Hints 教学：我犯过的 3 个菜鸟错误〉底下，良葛格的留言。

pyupgrade 功能与小结
具体来说，pyupgrade 会自动将旧的 type hints 语法转换为新版语法。

上述的，将自动修正为写法——只要我指定了 Python 3.10 以上的版本。Optional|

但 pyupgrade 会修正的部分，远不止 type hints，这只是一个例子。

启用 pyupgrade，可以自动帮你把这些旧语法转换为新版（由 requires-python 指定目标 Python 版本）语法。

这不仅让你的代码更干净，也能避免不同成员写出风格不一致的 Python 代码。

喜欢这篇文章？ 欢迎订阅本站，或支持我的创作。
相关文章
Python 开发：Ruff Linter、Formatter 介绍 + 设定教学
Flake8 与 isort in VS Code
Python 开发：pre-commit 设定 Git Hooks 教学