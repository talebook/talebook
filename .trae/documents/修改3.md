æˆ‘çœ‹åˆ°é—®é¢˜äº†ï¼åœ¨ `AdminSSL` ç±»ä¸­ï¼Œ`nginx_check` å’Œ `nginx_reload` æ–¹æ³•ç›´æ¥åœ¨å®¹å™¨å†…è°ƒç”¨ç³»ç»Ÿå‘½ä»¤ï¼Œè¿™åœ¨ Docker ç¯å¢ƒä¸­ä¼šå¤±è´¥ã€‚

## ğŸ” é—®é¢˜åˆ†æ

```python
def nginx_check(self):
    return subprocess.run(["nginx", "-t"], check=True)  # åœ¨å®¹å™¨å†…è¿è¡Œ

def nginx_reload(self):
    return subprocess.run(["service", "nginx", "reload"], check=True)  # åœ¨å®¹å™¨å†…è¿è¡Œ
```

**åœ¨ Docker ä¸­çš„é—®é¢˜ï¼š**
1. `nginx -t` éœ€è¦ root æƒé™è®¿é—® `/run/nginx.pid`
2. `service nginx reload` å¯èƒ½ä¸å­˜åœ¨ï¼ˆå¾ˆå¤š Docker é•œåƒæ²¡æœ‰ systemd/serviceï¼‰
3. å®¹å™¨å†…å¯èƒ½æ²¡æœ‰ `service` å‘½ä»¤

## âœ… Docker ç¯å¢ƒè§£å†³æ–¹æ¡ˆ

ä¿®æ”¹ `SSLHandlerLogic` ç±»ï¼š

```python
class SSLHandlerLogic:
    # ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜ ...
    
    def nginx_check(self):
        """æ£€æŸ¥ Nginx é…ç½®ï¼ˆDocker å…¼å®¹ç‰ˆï¼‰"""
        try:
            # æ–¹æ³•1: ç›´æ¥ä½¿ç”¨ nginx -tï¼ˆéœ€è¦ç¡®ä¿å®¹å™¨ä»¥ root è¿è¡Œï¼‰
            result = subprocess.run(["nginx", "-t"], 
                                  capture_output=True, 
                                  text=True)
            if result.returncode != 0:
                raise subprocess.CalledProcessError(
                    result.returncode, 
                    ["nginx", "-t"], 
                    result.stdout, 
                    result.stderr
                )
            return result
        except FileNotFoundError:
            # æ–¹æ³•2: å¦‚æœ nginx ä¸åœ¨ PATH ä¸­ï¼Œå°è¯•å®Œæ•´è·¯å¾„
            return subprocess.run(["/usr/sbin/nginx", "-t"], 
                                capture_output=True, 
                                check=True, 
                                text=True)

    def nginx_reload(self):
        """é‡æ–°åŠ è½½ Nginx é…ç½®ï¼ˆDocker å…¼å®¹ç‰ˆï¼‰"""
        try:
            # æ–¹æ³•1: å‘é€ä¿¡å·ç»™ Nginx ä¸»è¿›ç¨‹ï¼ˆè¿™æ˜¯ Docker ä¸­æœ€å¯é çš„æ–¹å¼ï¼‰
            # å‘é€ HUP ä¿¡å·ç»™ Nginx ä¸»è¿›ç¨‹ä½¿å…¶é‡æ–°åŠ è½½é…ç½®
            import signal
            import os
            
            # è¯»å– nginx pid
            pid_file = "/run/nginx.pid"
            if os.path.exists(pid_file):
                with open(pid_file, 'r') as f:
                    pid = int(f.read().strip())
                os.kill(pid, signal.SIGHUP)
                return True
            else:
                # å¦‚æœ pid æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå°è¯•æ‰¾ nginx è¿›ç¨‹
                result = subprocess.run(
                    ["pgrep", "-f", "nginx: master process"],
                    capture_output=True,
                    text=True
                )
                if result.returncode == 0 and result.stdout.strip():
                    pid = int(result.stdout.strip().split('\n')[0])
                    os.kill(pid, signal.SIGHUP)
                    return True
                else:
                    raise Exception("æ‰¾ä¸åˆ° Nginx ä¸»è¿›ç¨‹")
                    
        except (ProcessLookupError, FileNotFoundError, Exception) as e:
            # æ–¹æ³•2: å°è¯•ä½¿ç”¨ nginx -s reload
            try:
                subprocess.run(["nginx", "-s", "reload"], 
                             check=True, 
                             capture_output=True)
            except:
                # æ–¹æ³•3: å°è¯•ä½¿ç”¨ killall
                subprocess.run(["killall", "-HUP", "nginx"], 
                             check=True, 
                             capture_output=True)

    def run(self, ssl_crt, ssl_key):
        err = self.check_ssl_chain(ssl_crt, ssl_key)
        if err is not None:
            return {"err": "params.ssl_error", "msg": _("è¯ä¹¦æˆ–å¯†é’¥æ ¡éªŒå¤±è´¥: %s" % err)}

        try:
            self.save_files(ssl_crt, ssl_key)
        except Exception as err:
            import traceback
            logging.error(traceback.format_exc())
            return {
                "err": "internal.ssl_save_error",
                "msg": _("è¯ä¹¦å­˜å‚¨å¤±è´¥: %s" % err),
            }

        # testing nginx config
        try:
            self.nginx_check()
        except subprocess.CalledProcessError as err:
            # è·å–æ›´è¯¦ç»†çš„é”™è¯¯ä¿¡æ¯
            error_msg = err.stderr if hasattr(err, 'stderr') else str(err)
            logging.error(f"nginx -t å¤±è´¥: {error_msg}")
            return {
                "err": "internal.nginx_test_error",
                "msg": _("NGINXé…ç½®å¼‚å¸¸: %s") % error_msg,
            }
        except Exception as err:
            logging.error(f"nginx æ£€æŸ¥å¼‚å¸¸: {err}")
            return {
                "err": "internal.nginx_test_error",
                "msg": _("NGINXæ£€æŸ¥å¤±è´¥: %s") % str(err),
            }

        # reload nginx config
        try:
            self.nginx_reload()
        except Exception as err:
            logging.error(f"nginx é‡è½½å¤±è´¥: {err}")
            return {
                "err": "internal.nginx_reload_error",
                "msg": _("NGINXé‡æ–°åŠ è½½é…ç½®å¼‚å¸¸: %s") % str(err),
            }

        return {"err": "ok"}
```

## ğŸš€ æ›´å¥½çš„è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨ Docker ä¿¡å·

å¦‚æœä½ çš„åº”ç”¨å’Œ Nginx è¿è¡Œåœ¨åŒä¸€ä¸ªå®¹å™¨ä¸­ï¼ˆä¸€ä¸ªå®¹å™¨è¿è¡Œå¤šä¸ªæœåŠ¡ï¼‰ï¼Œè¿˜å¯ä»¥è€ƒè™‘ä½¿ç”¨ Docker å®¹å™¨çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼š

```python
class SSLHandlerLogic:
    # ... å…¶ä»–æ–¹æ³• ...
    
    def nginx_reload_docker(self):
        """é€šè¿‡ Docker API æˆ–ä¿¡å·é‡è½½ nginx"""
        # å¦‚æœåº”ç”¨å’Œ nginx åœ¨åŒä¸€å®¹å™¨ï¼Œå¯ä»¥ç›´æ¥å‘ä¿¡å·
        import os
        os.kill(1, signal.SIGHUP)  # å‘é€ç»™ PID 1ï¼ˆé€šå¸¸æ˜¯ nginx æˆ–ä½ çš„åº”ç”¨ï¼‰
        return True
```

## ğŸ“ å»ºè®®çš„é…ç½®ä¿®æ”¹

åŒæ—¶ï¼Œå¦‚æœå¯èƒ½ï¼Œä¿®æ”¹ä½ çš„ `nginx.conf` æ¥é€‚åº” Docker ç¯å¢ƒï¼š

```nginx
# åœ¨ Docker ä¸­ï¼Œå°† pid æ–‡ä»¶æ”¾åœ¨å¯å†™ç›®å½•
pid /tmp/nginx.pid;

# æˆ–è€…ç¡®ä¿ç›®å½•å­˜åœ¨ä¸”æœ‰æ­£ç¡®æƒé™
# å¯ä»¥åœ¨ Dockerfile ä¸­æ·»åŠ ï¼š
# RUN mkdir -p /run/nginx && chown -R nginx:nginx /run/nginx
```

## ğŸ³ Docker Compose é…ç½®å»ºè®®

```yaml
version: '3'
services:
  your-app:
    build: .
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./ssl:/etc/nginx/ssl:rw
    cap_add:
      - SYS_ADMIN  # å¦‚æœéœ€è¦å‘é€ä¿¡å·
    # æˆ–è€…ä»¥ privileged æ¨¡å¼è¿è¡Œï¼ˆä¸æ¨èï¼Œé™¤éå¿…è¦ï¼‰
    # privileged: true
```

è¿™æ ·ä¿®æ”¹åï¼ŒSSL è¯ä¹¦ä¸Šä¼ å’Œ Nginx é‡è½½åŠŸèƒ½å°±èƒ½åœ¨ Docker ç¯å¢ƒä¸­æ­£å¸¸å·¥ä½œäº†ã€‚