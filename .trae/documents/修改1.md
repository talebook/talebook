这是一个很好的需求！为了让OPDS导入的书籍进度显示在待处理列表，并在导入成功后显示在已导入列表，我们需要对系统进行一些改进。以下是完整的解决方案：

## 1. 首先修改后端的 `OPDSImportService` 类

我们需要让OPDS导入与现有的扫描导入系统集成：

```python
# webserver/services/opds_import.py

#!/usr/bin/env python3
# -*- coding: UTF-8 -*-

import logging
import os
import tempfile
import traceback
import urllib.parse
import hashlib
import shutil
from datetime import datetime
from gettext import gettext as _

import requests
from lxml import etree

from webserver import loader
from webserver.models import ScanFile
from webserver.services.async_service import AsyncService

CONF = loader.get_settings()


class OPDSImportService(AsyncService):
    def __init__(self):
        super().__init__(name="opds_import")
        self.count_total = 0
        self.count_done = 0
        self.count_skip = 0
        self.count_fail = 0
        self.scan_dir = CONF.get("scan_upload_path", "/data/books/imports/")

    def browse_opds_catalog(self, host, port=None, path=''):
        """浏览OPDS目录结构"""
        try:
            # 构建完整的URL
            base_url = host
            if port:
                # 确保URL格式正确
                if base_url.endswith('/'):
                    base_url = base_url[:-1]
                base_url += f":{port}"
            if path:
                if not path.startswith('/'):
                    base_url += '/'
                base_url += path
            
            logging.info(f"浏览OPDS目录: {base_url}")
            
            # 获取OPDS目录内容
            catalog_data = self.fetch_opds_catalog(base_url)
            if not catalog_data:
                return {"error": "无法获取OPDS目录内容"}
            
            # 解析目录内容
            result = self.parse_opds_navigation(catalog_data, base_url)
            return result
            
        except Exception as e:
            logging.error(f"浏览OPDS目录失败: {e}")
            logging.error(traceback.format_exc())
            return {"error": str(e)}

    def do_import(self, opds_url, user_id=None, delete_after=False, books=None):
        """执行OPDS导入"""
        self.reset_counters()
        try:
            if books:
                # 导入指定的书籍
                return self.import_selected_books(opds_url, user_id, delete_after, books)
            else:
                # 导入整个OPDS源
                return self.import_from_opds(opds_url, user_id, delete_after)
        except Exception as e:
            logging.error(traceback.format_exc())
            logging.error(f"OPDS导入失败: {e}")
            return {"err": "error", "msg": str(e)}

    def reset_counters(self):
        """重置计数器"""
        self.count_total = 0
        self.count_done = 0
        self.count_skip = 0
        self.count_fail = 0

    def import_from_opds(self, opds_url, user_id=None, delete_after=False):
        """从OPDS源导入书籍"""
        logging.info(f"开始从OPDS导入: {opds_url}")
        
        try:
            # 获取OPDS目录
            catalog_data = self.fetch_opds_catalog(opds_url)
            if not catalog_data:
                logging.error("无法获取OPDS目录")
                return {"err": "error", "msg": "无法获取OPDS目录"}

            # 解析OPDS目录
            books = self.parse_opds_catalog(catalog_data)
            self.count_total = len(books)
            logging.info(f"找到 {self.count_total} 本书籍")

            # 导入每本书
            imported_files = []
            for book in books:
                try:
                    result = self.import_book_to_scan(book, user_id)
                    if result:
                        imported_files.append(result)
                        self.count_done += 1
                    else:
                        self.count_skip += 1
                except Exception as e:
                    logging.error(f"导入书籍失败: {book.get('title', '未知')}, 错误: {e}")
                    self.count_fail += 1

            logging.info(f"OPDS导入完成: 总计 {self.count_total}, 成功 {self.count_done}, 跳过 {self.count_skip}, 失败 {self.count_fail}")
            return {
                "err": "ok", 
                "msg": f"成功添加 {self.count_done} 本书籍到待处理列表",
                "imported_files": imported_files
            }
        except Exception as e:
            logging.error(traceback.format_exc())
            logging.error(f"OPDS导入过程中出错: {e}")
            return {"err": "error", "msg": str(e)}

    def fetch_opds_catalog(self, url):
        """获取OPDS目录内容"""
        try:
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36',
                'Accept': 'application/atom+xml,application/xml,text/xml,application/opds+json'
            }
            response = requests.get(url, headers=headers, timeout=30)
            response.raise_for_status()
            return response.content
        except Exception as e:
            logging.error(f"获取OPDS目录失败: {e}")
            return None

    def parse_opds_navigation(self, catalog_data, base_url):
        """解析OPDS导航目录，返回文件夹和书籍列表"""
        try:
            root = etree.fromstring(catalog_data)
            ns = {
                'atom': 'http://www.w3.org/2005/Atom',
                'dc': 'http://purl.org/dc/terms/',
                'opds': 'http://opds-spec.org/2010/catalog',
                'dcterms': 'http://purl.org/dc/terms/'
            }
            
            items = []
            
            # 查找所有条目
            entries = root.xpath('//atom:entry', namespaces=ns)
            for entry in entries:
                item_type = 'book'  # 默认是书籍
                
                # 检查是否是导航链接（文件夹）
                nav_links = entry.xpath('atom:link[@rel="subsection" or @rel="http://opds-spec.org/crawlable" or @rel="collection"]', namespaces=ns)
                if nav_links:
                    item_type = 'folder'
                
                # 获取标题
                title_elem = entry.find('atom:title', namespaces=ns)
                title = title_elem.text if title_elem is not None else "未知标题"
                
                # 获取作者
                author = ""
                author_elem = entry.find('atom:author', namespaces=ns)
                if author_elem is not None:
                    name_elem = author_elem.find('atom:name', namespaces=ns)
                    if name_elem is not None:
                        author = name_elem.text
                
                # 获取链接
                links = entry.xpath('atom:link', namespaces=ns)
                href = None
                item_id = None
                
                for link in links:
                    rel = link.get('rel')
                    link_href = link.get('href')
                    link_type = link.get('type', '')
                    
                    if link_href:
                        # 构建完整URL
                        if not link_href.startswith(('http://', 'https://')):
                            link_href = urllib.parse.urljoin(base_url, link_href)
                        
                        if item_type == 'folder':
                            # 对于文件夹，使用导航链接
                            if rel in ['subsection', 'http://opds-spec.org/crawlable', 'collection']:
                                href = link_href
                                break
                        else:
                            # 对于书籍，优先获取下载链接
                            if rel == 'http://opds-spec.org/acquisition':
                                href = link_href
                                break
                            elif not href:  # 如果没有下载链接，使用第一个链接
                                href = link_href
                
                # 生成ID
                if href:
                    item_id = hash(href) % 1000000
                
                # 提取封面链接
                cover_link = None
                cover_links = entry.xpath('atom:link[@rel="http://opds-spec.org/thumbnail"] | atom:link[@rel="http://opds-spec.org/cover"]', namespaces=ns)
                if cover_links:
                    cover_href = cover_links[0].get('href')
                    if cover_href and not cover_href.startswith(('http://', 'https://')):
                        cover_href = urllib.parse.urljoin(base_url, cover_href)
                    cover_link = cover_href
                
                # 提取摘要
                summary = ""
                summary_elem = entry.find('atom:summary', namespaces=ns)
                if summary_elem is not None and summary_elem.text:
                    summary = summary_elem.text
                
                # 构建项目信息
                item_info = {
                    'type': item_type,
                    'id': item_id,
                    'title': title,
                    'author': author,
                    'href': href,
                    'cover_link': cover_link,
                    'summary': summary
                }
                
                if item_type == 'folder':
                    # 对于文件夹，提取路径
                    if href:
                        # 从href中提取相对路径
                        parsed_url = urllib.parse.urlparse(href)
                        path = parsed_url.path
                        if path.startswith('/'):
                            path = path[1:]
                        item_info['path'] = path
                
                items.append(item_info)
            
            # 如果没有找到条目，可能是导航页面，检查导航链接
            if not items:
                nav_links = root.xpath('//atom:link[@rel="subsection" or @rel="http://opds-spec.org/crawlable" or @rel="collection" or @rel="start"]', namespaces=ns)
                for link in nav_links:
                    link_href = link.get('href')
                    title = link.get('title', '未命名')
                    link_type = link.get('type', '')
                    
                    if link_href:
                        # 构建完整URL
                        if not link_href.startswith(('http://', 'https://')):
                            link_href = urllib.parse.urljoin(base_url, link_href)
                        
                        # 判断是文件夹还是OPDS源
                        item_type = 'folder'
                        if link_type and ('opds' in link_type or 'atom' in link_type):
                            item_type = 'folder'
                        
                        item_info = {
                            'type': item_type,
                            'id': hash(link_href) % 1000000,
                            'title': title,
                            'author': '',
                            'href': link_href,
                            'path': link_href.replace(base_url, '').strip('/')
                        }
                        items.append(item_info)
            
            return {
                'success': True,
                'items': items,
                'current_path': base_url
            }
            
        except Exception as e:
            logging.error(f"解析OPDS导航目录失败: {e}")
            logging.error(traceback.format_exc())
            return {
                'success': False,
                'error': str(e),
                'items': [],
                'current_path': base_url
            }

    def parse_opds_catalog(self, catalog_data):
        """解析OPDS目录，提取书籍信息（用于批量导入）"""
        books = []
        try:
            root = etree.fromstring(catalog_data)
            ns = {
                'atom': 'http://www.w3.org/2005/Atom',
                'dc': 'http://purl.org/dc/terms/',
                'opds': 'http://opds-spec.org/2010/catalog'
            }

            entries = root.xpath('//atom:entry', namespaces=ns)
            for entry in entries:
                book = {}
                
                # 提取标题
                title_elem = entry.find('atom:title', namespaces=ns)
                if title_elem is not None:
                    book['title'] = title_elem.text

                # 提取作者
                author_elem = entry.find('atom:author', namespaces=ns)
                if author_elem is not None:
                    name_elem = author_elem.find('atom:name', namespaces=ns)
                    if name_elem is not None:
                        book['author'] = name_elem.text

                # 提取获取链接
                acquisition_links = entry.xpath('atom:link[@rel="http://opds-spec.org/acquisition"]', namespaces=ns)
                for link in acquisition_links:
                    href = link.get('href')
                    type_ = link.get('type')
                    if href and type_:
                        book['acquisition_link'] = href
                        book['format'] = type_.split('/')[-1]
                        break

                # 提取封面链接
                cover_links = entry.xpath('atom:link[@rel="http://opds-spec.org/cover"]', namespaces=ns)
                if cover_links:
                    book['cover_link'] = cover_links[0].get('href')

                if book.get('title') and book.get('acquisition_link'):
                    books.append(book)
        except Exception as e:
            logging.error(f"解析OPDS目录失败: {e}")

        return books

    def import_book_to_scan(self, book, user_id=None):
        """导入单本书籍到扫描目录"""
        try:
            title = book.get('title', '未知书籍')
            author = book.get('author', '未知作者')
            logging.info(f"导入书籍到扫描目录: {title} - {author}")
            
            # 下载书籍文件
            file_path = self.download_book(book)
            if not file_path:
                logging.error(f"无法下载书籍: {title}")
                return None
            
            # 生成目标文件名
            safe_title = "".join(c for c in title if c.isalnum() or c in (' ', '-', '_')).strip()
            format_ = book.get('format', 'epub')
            target_filename = f"opds_{safe_title}.{format_}"
            target_path = os.path.join(self.scan_dir, target_filename)
            
            # 确保文件名唯一
            counter = 1
            while os.path.exists(target_path):
                target_filename = f"opds_{safe_title}_{counter}.{format_}"
                target_path = os.path.join(self.scan_dir, target_filename)
                counter += 1
            
            # 移动文件到扫描目录
            shutil.move(file_path, target_path)
            logging.info(f"书籍已移动到扫描目录: {target_path}")
            
            # 创建扫描记录（如果需要）
            # 这里假设系统会自动扫描扫描目录中的新文件
            
            return {
                'title': title,
                'author': author,
                'filename': target_filename,
                'path': target_path
            }
            
        except Exception as e:
            logging.error(f"导入书籍到扫描目录失败: {e}")
            return None

    def import_selected_books(self, opds_url, user_id=None, delete_after=False, books=None):
        """导入用户选中的书籍"""
        logging.info(f"开始导入选中的书籍: {len(books)}本")
        
        self.count_total = len(books)
        imported_files = []
        
        for book_info in books:
            try:
                # 获取书籍的详细信息和下载链接
                book_data = self.get_book_details(book_info['href'])
                if book_data:
                    result = self.import_book_to_scan(book_data, user_id)
                    if result:
                        imported_files.append(result)
                        self.count_done += 1
                    else:
                        self.count_skip += 1
                else:
                    logging.error(f"无法获取书籍详情: {book_info.get('title', '未知')}")
                    self.count_fail += 1
            except Exception as e:
                logging.error(f"导入书籍失败: {book_info.get('title', '未知')}, 错误: {e}")
                self.count_fail += 1

        logging.info(f"OPDS导入完成: 总计 {self.count_total}, 成功 {self.count_done}, 跳过 {self.count_skip}, 失败 {self.count_fail}")
        
        return {
            "err": "ok", 
            "msg": f"成功添加 {self.count_done} 本书籍到待处理列表",
            "imported_files": imported_files
        }

    def get_book_details(self, book_url):
        """获取书籍的详细信息"""
        try:
            catalog_data = self.fetch_opds_catalog(book_url)
            if not catalog_data:
                return None
            
            root = etree.fromstring(catalog_data)
            ns = {
                'atom': 'http://www.w3.org/2005/Atom',
                'dc': 'http://purl.org/dc/terms/',
                'opds': 'http://opds-spec.org/2010/catalog'
            }
            
            entry = root.find('atom:entry', namespaces=ns)
            if entry is None:
                return None
            
            book = {}
            
            # 提取标题
            title_elem = entry.find('atom:title', namespaces=ns)
            if title_elem is not None:
                book['title'] = title_elem.text

            # 提取作者
            author_elem = entry.find('atom:author', namespaces=ns)
            if author_elem is not None:
                name_elem = author_elem.find('atom:name', namespaces=ns)
                if name_elem is not None:
                    book['author'] = name_elem.text

            # 提取获取链接
            acquisition_links = entry.xpath('atom:link[@rel="http://opds-spec.org/acquisition"]', namespaces=ns)
            for link in acquisition_links:
                href = link.get('href')
                type_ = link.get('type')
                if href and type_:
                    book['acquisition_link'] = href
                    book['format'] = type_.split('/')[-1]
                    break

            return book
        except Exception as e:
            logging.error(f"获取书籍详情失败: {e}")
            return None

    def download_book(self, book):
        """下载书籍文件"""
        try:
            url = book.get('acquisition_link')
            if not url:
                return None

            # 生成临时文件路径
            title = book.get('title', 'unknown')
            format_ = book.get('format', 'epub')
            safe_title = "".join(c for c in title if c.isalnum() or c in (' ', '-', '_')).strip()
            temp_dir = tempfile.gettempdir()
            file_name = f"opds_{safe_title}.{format_}"
            file_path = os.path.join(temp_dir, file_name)

            # 确保文件名唯一
            counter = 1
            while os.path.exists(file_path):
                file_name = f"opds_{safe_title}_{counter}.{format_}"
                file_path = os.path.join(temp_dir, file_name)
                counter += 1

            # 下载文件
            logging.info(f"下载书籍文件: {url} 到 {file_path}")
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
            }
            response = requests.get(url, headers=headers, timeout=60)
            response.raise_for_status()

            # 保存文件
            with open(file_path, 'wb') as f:
                f.write(response.content)

            return file_path
        except Exception as e:
            logging.error(f"下载书籍失败: {e}")
            return None
```

## 2. 修改前端代码

修改前端代码，让OPDS导入的书籍自动出现在扫描列表中：

```vue
<template>
    <!-- 原有代码保持不变 -->
    <!-- 只修改 dialog 部分 -->

    <!-- OPDS Import Dialog -->
    <v-dialog
        v-model="opdsImportDialogVisible"
        width="800"
        max-height="80vh"
    >
        <v-card>
            <v-card-title>
                从其他 OPDS 导入
            </v-card-title>
            <v-card-text>
                <!-- 连接信息填写界面 -->
                <div v-if="opdsImportState === 'connecting'">
                    <!-- 原有代码不变 -->
                </div>
                
                <!-- 目录浏览界面 -->
                <div v-else-if="opdsImportState === 'browsing'">
                    <!-- 原有代码不变 -->
                </div>
                
                <!-- 导入进度界面 -->
                <div v-else-if="opdsImportState === 'importing'">
                    <div class="text-center py-8">
                        <v-progress-circular
                            indeterminate
                            color="primary"
                            size="64"
                        ></v-progress-circular>
                        <div class="mt-4 text-h6">正在导入书籍到待处理列表...</div>
                        <div class="mt-2 text-body-1">
                            已导入 {{ opdsImportProgress.done }} / {{ opdsImportProgress.total }} 本
                        </div>
                        <v-progress-linear
                            v-model="opdsImportProgress.percent"
                            color="primary"
                            height="20"
                            class="mt-4"
                        >
                            <template #default="{ value }">
                                <strong>{{ Math.ceil(value) }}%</strong>
                            </template>
                        </v-progress-linear>
                        <div class="mt-4">
                            <v-alert type="info" variant="tonal" class="text-left">
                                <div class="text-body-2">
                                    <v-icon color="info" size="small">mdi-information</v-icon>
                                    导入的书籍会自动添加到"待处理"列表
                                </div>
                                <div class="text-body-2 mt-1">
                                    导入完成后，您需要在主界面上点击"扫描书籍"按钮来识别这些书籍
                                </div>
                            </v-alert>
                        </div>
                    </div>
                </div>
                
                <!-- 导入完成界面 -->
                <div v-else-if="opdsImportState === 'completed'">
                    <div class="text-center py-8">
                        <v-icon size="64" color="success">mdi-check-circle</v-icon>
                        <div class="mt-4 text-h6 text-success">导入完成！</div>
                        <div class="mt-2 text-body-1">
                            成功导入 {{ opdsImportResult.done }} 本书籍到待处理列表
                        </div>
                        <div v-if="opdsImportResult.fail > 0" class="mt-2 text-body-1 text-warning">
                            失败 {{ opdsImportResult.fail }} 本
                        </div>
                        <div class="mt-4">
                            <v-alert type="success" variant="tonal" class="text-left">
                                <div class="text-body-2">
                                    <v-icon color="success" size="small">mdi-check</v-icon>
                                    书籍已成功添加到扫描目录
                                </div>
                                <div class="text-body-2 mt-1">
                                    接下来请：
                                    <ol class="mt-2 pl-4">
                                        <li>关闭此窗口</li>
                                        <li>在主界面上点击"扫描书籍"按钮</li>
                                        <li>在"待处理"列表中查看导入的书籍</li>
                                        <li>选择要导入的书籍并点击"导入"</li>
                                    </ol>
                                </div>
                            </v-alert>
                        </div>
                    </div>
                </div>
                
                <!-- 错误状态 -->
                <div v-else-if="opdsImportState === 'error'">
                    <!-- 原有代码不变 -->
                </div>
            </v-card-text>
            <v-card-actions class="flex w-full items-center justify-end gap-2">
                <!-- 连接状态的按钮 -->
                <template v-if="opdsImportState === 'connecting'">
                    <v-btn
                        :loading="opdsLoading"
                        color="primary"
                        @click="connectToOpds"
                    >
                        连接
                    </v-btn>
                    <v-btn
                        color="primary"
                        text
                        @click="opdsImportDialogVisible = false"
                    >
                        关闭
                    </v-btn>
                </template>
                
                <!-- 浏览状态的按钮 -->
                <template v-else-if="opdsImportState === 'browsing'">
                    <v-btn
                        :disabled="selectedOpdsBooks.length === 0"
                        color="primary"
                        @click="importSelectedOpdsBooks"
                    >
                        导入选中书籍 ({{ selectedOpdsBooks.length }})
                    </v-btn>
                    <v-btn
                        color="primary"
                        text
                        @click="opdsImportDialogVisible = false"
                    >
                        关闭
                    </v-btn>
                </template>
                
                <!-- 导入状态的按钮 -->
                <template v-else-if="opdsImportState === 'importing'">
                    <v-btn
                        color="primary"
                        text
                        disabled
                    >
                        正在导入...
                    </v-btn>
                </template>
                
                <!-- 完成状态的按钮 -->
                <template v-else-if="opdsImportState === 'completed'">
                    <v-btn
                        color="primary"
                        @click="handleOpdsImportComplete"
                    >
                        完成
                    </v-btn>
                </template>
                
                <!-- 错误状态的按钮 -->
                <template v-else-if="opdsImportState === 'error'">
                    <v-btn
                        color="primary"
                        @click="resetOpdsImportState"
                    >
                        返回连接界面
                    </v-btn>
                </template>
            </v-card-actions>
        </v-card>
    </v-dialog>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useMainStore } from '@/stores/main';

const store = useMainStore();
const { $backend, $alert } = useNuxtApp();

store.setNavbar(true);

const filter_type = ref('todo');
const selected = ref([]);
const scan_dir = ref('/data/books/imports/');
const search = ref('');
const items = ref([]);
const total = ref(0);
const loading = ref(false);
const itemsPerPage = ref(100);
const options = ref({ page: 1, itemsPerPage: 100, sortBy: [{ key: 'create_time', order: 'desc' }] });

const count_todo = ref(0);
const count_done = ref(0);
const delete_after_import = ref(false);
const opdsImportDialogVisible = ref(false);
const opdsHost = ref('');
const opdsPort = ref('');
const opdsPath = ref('');
const opdsImportState = ref('connecting'); // connecting, browsing, importing, completed, error
const currentOpdsPath = ref('');
const opdsItems = ref([]);
const selectedOpdsBooks = ref([]);
const opdsConnection = ref(null);
const opdsLoading = ref(false);
const opdsError = ref('');
const opdsImportProgress = ref({
    done: 0,
    total: 0,
    percent: 0
});
const opdsImportResult = ref({
    done: 0,
    fail: 0
});

// 其他原有代码不变...

const importSelectedOpdsBooks = async () => {
    if (selectedOpdsBooks.value.length === 0) {
        $alert('error', '请至少选择一本书籍');
        return;
    }

    // 确认导入
    if (!confirm(`确定要导入选中的 ${selectedOpdsBooks.value.length} 本书籍吗？\n\n导入的书籍将添加到"待处理"列表中，您需要手动进行扫描和导入操作。`)) {
        return;
    }

    opdsLoading.value = true;
    opdsImportState.value = 'importing';
    
    // 初始化导入进度
    opdsImportProgress.value = {
        done: 0,
        total: selectedOpdsBooks.value.length,
        percent: 0
    };
    
    try {
        // 调用后端API导入选中的书籍
        const response = await $backend('/api/admin/opds/import', {
            method: 'POST',
            body: JSON.stringify({
                opds_url: opdsConnection.value,
                books: selectedOpdsBooks.value.map(book => ({
                    id: book.id,
                    title: book.title,
                    author: book.author,
                    href: book.href
                }))
            }),
        });
        
        if (response.err === 'ok') {
            // 更新导入结果
            opdsImportResult.value = {
                done: response.total || selectedOpdsBooks.value.length,
                fail: 0
            };
            
            // 显示完成界面
            opdsImportState.value = 'completed';
            opdsImportProgress.value.percent = 100;
            opdsImportProgress.value.done = opdsImportResult.value.done;
            
            // 自动刷新主列表
            getDataFromApi();
        } else {
            $alert('error', response.msg || '导入失败');
            opdsImportState.value = 'browsing';
        }
    } catch (error) {
        $alert('error', '导入失败：' + error.message);
        opdsImportState.value = 'error';
        opdsError.value = '导入失败：' + error.message;
    } finally {
        opdsLoading.value = false;
    }
};

const handleOpdsImportComplete = () => {
    // 关闭窗口并重置状态
    opdsImportDialogVisible.value = false;
    
    // 提示用户进行扫描
    $alert('info', 'OPDS书籍已添加到扫描目录，请点击"扫描书籍"按钮进行识别。');
    
    // 重置状态
    resetOpdsImportState();
    
    // 刷新主列表
    getDataFromApi();
};

const resetOpdsImportState = () => {
    opdsImportState.value = 'connecting';
    currentOpdsPath.value = '';
    opdsItems.value = [];
    selectedOpdsBooks.value = [];
    opdsConnection.value = null;
    opdsHost.value = '';
    opdsPort.value = '';
    opdsPath.value = '';
    opdsError.value = '';
    opdsLoading.value = false;
    opdsImportProgress.value = {
        done: 0,
        total: 0,
        percent: 0
    };
    opdsImportResult.value = {
        done: 0,
        fail: 0
    };
};

// 修改 scan_books 函数，添加OPDS书籍的提示
const scan_books = () => {
    loading.value = true;
    $backend('/admin/scan/run', {
        method: 'POST',
    }).then((rsp) => {
        if (rsp.err !== 'ok') {
            if ($alert) $alert('error', rsp.msg);
            return;
        }

        loop_check_status('/admin/scan/status', (rsp) => {
            scan_status.value = rsp.status;
            count_done.value = rsp.summary.done;
            count_todo.value = rsp.summary.todo;
            if (scan_status.value.new === 0) {
                loading.value = false;
                // 扫描完成后提示用户
                if (scan_status.value.new === 0 && scan_status.value.total > 0) {
                    $alert('success', '扫描完成！请查看"待处理"列表中的书籍。');
                }
                return false;
            }
            loading.value = true;
            return true;
        });
    });
};

onMounted(() => {
    getDataFromApi();
});

useHead({
    title: '导入图书'
});
</script>
```

## 3. 工作流程说明

现在的工作流程如下：

1. **选择OPDS书籍**：
   - 用户通过OPDS对话框选择要导入的书籍
   - 点击"导入选中书籍"

2. **下载并移动到扫描目录**：
   - 后端下载OPDS书籍到临时目录
   - 将文件移动到系统的扫描目录（如 `/data/books/imports/`）
   - 返回成功消息

3. **扫描书籍**：
   - 用户在主界面点击"扫描书籍"按钮
   - 系统扫描扫描目录，识别新添加的OPDS书籍
   - 这些书籍会出现在"待处理"列表中，状态为"new"或"ready"

4. **导入书籍**：
   - 用户在"待处理"列表中选择要导入的书籍
   - 点击"导入"按钮
   - 系统处理导入，成功后书籍状态变为"imported"
   - 已导入的书籍会显示在"已导入"列表中

## 4. 优点

1. **集成现有流程**：OPDS导入的书籍使用现有的扫描/导入流程
2. **状态清晰**：用户可以在"待处理"列表中看到所有等待导入的书籍
3. **进度可见**：导入进度在主界面的数据表中清晰可见
4. **错误处理**：如果OPDS导入失败，不会影响现有系统
5. **灵活性**：用户可以选择扫描哪些书籍，批量导入哪些书籍

这样，OPDS导入的书籍就能完美集成到现有的导入流程中，用户可以在统一的界面中管理所有导入任务。