这是一个很好的需求！为了让OPDS导入的书籍进度显示在待处理列表，并在导入成功后显示在已导入列表，我们需要对系统进行一些改进。以下是完整的解决方案：`

## 1. 修改前端代码

修改前端代码，让OPDS导入的书籍自动出现在扫描列表中：

```vue
<template>
    <!-- 原有代码保持不变 -->
    <!-- 只修改 dialog 部分 -->

    <!-- OPDS Import Dialog -->
    <v-dialog
        v-model="opdsImportDialogVisible"
        width="800"
        max-height="80vh"
    >
        <v-card>
            <v-card-title>
                从其他 OPDS 导入
            </v-card-title>
            <v-card-text>
                <!-- 连接信息填写界面 -->
                <div v-if="opdsImportState === 'connecting'">
                    <!-- 原有代码不变 -->
                </div>
                
                <!-- 目录浏览界面 -->
                <div v-else-if="opdsImportState === 'browsing'">
                    <!-- 原有代码不变 -->
                </div>
                
                <!-- 导入进度界面 -->
                <div v-else-if="opdsImportState === 'importing'">
                    <div class="text-center py-8">
                        <v-progress-circular
                            indeterminate
                            color="primary"
                            size="64"
                        ></v-progress-circular>
                        <div class="mt-4 text-h6">正在导入书籍到待处理列表...</div>
                        <div class="mt-2 text-body-1">
                            已导入 {{ opdsImportProgress.done }} / {{ opdsImportProgress.total }} 本
                        </div>
                        <v-progress-linear
                            v-model="opdsImportProgress.percent"
                            color="primary"
                            height="20"
                            class="mt-4"
                        >
                            <template #default="{ value }">
                                <strong>{{ Math.ceil(value) }}%</strong>
                            </template>
                        </v-progress-linear>
                        <div class="mt-4">
                            <v-alert type="info" variant="tonal" class="text-left">
                                <div class="text-body-2">
                                    <v-icon color="info" size="small">mdi-information</v-icon>
                                    导入的书籍会自动添加到"待处理"列表
                                </div>
                                <div class="text-body-2 mt-1">
                                    导入完成后，您需要在主界面上点击"扫描书籍"按钮来识别这些书籍
                                </div>
                            </v-alert>
                        </div>
                    </div>
                </div>
                
                <!-- 导入完成界面 -->
                <div v-else-if="opdsImportState === 'completed'">
                    <div class="text-center py-8">
                        <v-icon size="64" color="success">mdi-check-circle</v-icon>
                        <div class="mt-4 text-h6 text-success">导入完成！</div>
                        <div class="mt-2 text-body-1">
                            成功导入 {{ opdsImportResult.done }} 本书籍到待处理列表
                        </div>
                        <div v-if="opdsImportResult.fail > 0" class="mt-2 text-body-1 text-warning">
                            失败 {{ opdsImportResult.fail }} 本
                        </div>
                        <div class="mt-4">
                            <v-alert type="success" variant="tonal" class="text-left">
                                <div class="text-body-2">
                                    <v-icon color="success" size="small">mdi-check</v-icon>
                                    书籍已成功添加到扫描目录
                                </div>
                                <div class="text-body-2 mt-1">
                                    接下来请：
                                    <ol class="mt-2 pl-4">
                                        <li>关闭此窗口</li>
                                        <li>在主界面上点击"扫描书籍"按钮</li>
                                        <li>在"待处理"列表中查看导入的书籍</li>
                                        <li>选择要导入的书籍并点击"导入"</li>
                                    </ol>
                                </div>
                            </v-alert>
                        </div>
                    </div>
                </div>
                
                <!-- 错误状态 -->
                <div v-else-if="opdsImportState === 'error'">
                    <!-- 原有代码不变 -->
                </div>
            </v-card-text>
            <v-card-actions class="flex w-full items-center justify-end gap-2">
                <!-- 连接状态的按钮 -->
                <template v-if="opdsImportState === 'connecting'">
                    <v-btn
                        :loading="opdsLoading"
                        color="primary"
                        @click="connectToOpds"
                    >
                        连接
                    </v-btn>
                    <v-btn
                        color="primary"
                        text
                        @click="opdsImportDialogVisible = false"
                    >
                        关闭
                    </v-btn>
                </template>
                
                <!-- 浏览状态的按钮 -->
                <template v-else-if="opdsImportState === 'browsing'">
                    <v-btn
                        :disabled="selectedOpdsBooks.length === 0"
                        color="primary"
                        @click="importSelectedOpdsBooks"
                    >
                        导入选中书籍 ({{ selectedOpdsBooks.length }})
                    </v-btn>
                    <v-btn
                        color="primary"
                        text
                        @click="opdsImportDialogVisible = false"
                    >
                        关闭
                    </v-btn>
                </template>
                
                <!-- 导入状态的按钮 -->
                <template v-else-if="opdsImportState === 'importing'">
                    <v-btn
                        color="primary"
                        text
                        disabled
                    >
                        正在导入...
                    </v-btn>
                </template>
                
                <!-- 完成状态的按钮 -->
                <template v-else-if="opdsImportState === 'completed'">
                    <v-btn
                        color="primary"
                        @click="handleOpdsImportComplete"
                    >
                        完成
                    </v-btn>
                </template>
                
                <!-- 错误状态的按钮 -->
                <template v-else-if="opdsImportState === 'error'">
                    <v-btn
                        color="primary"
                        @click="resetOpdsImportState"
                    >
                        返回连接界面
                    </v-btn>
                </template>
            </v-card-actions>
        </v-card>
    </v-dialog>
</template>

<script setup>
import { ref, onMounted, computed } from 'vue';
import { useMainStore } from '@/stores/main';

const store = useMainStore();
const { $backend, $alert } = useNuxtApp();

store.setNavbar(true);

const filter_type = ref('todo');
const selected = ref([]);
const scan_dir = ref('/data/books/imports/');
const search = ref('');
const items = ref([]);
const total = ref(0);
const loading = ref(false);
const itemsPerPage = ref(100);
const options = ref({ page: 1, itemsPerPage: 100, sortBy: [{ key: 'create_time', order: 'desc' }] });

const count_todo = ref(0);
const count_done = ref(0);
const delete_after_import = ref(false);
const opdsImportDialogVisible = ref(false);
const opdsHost = ref('');
const opdsPort = ref('');
const opdsPath = ref('');
const opdsImportState = ref('connecting'); // connecting, browsing, importing, completed, error
const currentOpdsPath = ref('');
const opdsItems = ref([]);
const selectedOpdsBooks = ref([]);
const opdsConnection = ref(null);
const opdsLoading = ref(false);
const opdsError = ref('');
const opdsImportProgress = ref({
    done: 0,
    total: 0,
    percent: 0
});
const opdsImportResult = ref({
    done: 0,
    fail: 0
});

// 其他原有代码不变...

const importSelectedOpdsBooks = async () => {
    if (selectedOpdsBooks.value.length === 0) {
        $alert('error', '请至少选择一本书籍');
        return;
    }

    // 确认导入
    if (!confirm(`确定要导入选中的 ${selectedOpdsBooks.value.length} 本书籍吗？\n\n导入的书籍将添加到"待处理"列表中，您需要手动进行扫描和导入操作。`)) {
        return;
    }

    opdsLoading.value = true;
    opdsImportState.value = 'importing';
    
    // 初始化导入进度
    opdsImportProgress.value = {
        done: 0,
        total: selectedOpdsBooks.value.length,
        percent: 0
    };
    
    try {
        // 调用后端API导入选中的书籍
        const response = await $backend('/api/admin/opds/import', {
            method: 'POST',
            body: JSON.stringify({
                opds_url: opdsConnection.value,
                books: selectedOpdsBooks.value.map(book => ({
                    id: book.id,
                    title: book.title,
                    author: book.author,
                    href: book.href
                }))
            }),
        });
        
        if (response.err === 'ok') {
            // 更新导入结果
            opdsImportResult.value = {
                done: response.total || selectedOpdsBooks.value.length,
                fail: 0
            };
            
            // 显示完成界面
            opdsImportState.value = 'completed';
            opdsImportProgress.value.percent = 100;
            opdsImportProgress.value.done = opdsImportResult.value.done;
            
            // 自动刷新主列表
            getDataFromApi();
        } else {
            $alert('error', response.msg || '导入失败');
            opdsImportState.value = 'browsing';
        }
    } catch (error) {
        $alert('error', '导入失败：' + error.message);
        opdsImportState.value = 'error';
        opdsError.value = '导入失败：' + error.message;
    } finally {
        opdsLoading.value = false;
    }
};

const handleOpdsImportComplete = () => {
    // 关闭窗口并重置状态
    opdsImportDialogVisible.value = false;
    
    // 提示用户进行扫描
    $alert('info', 'OPDS书籍已添加到扫描目录，请点击"扫描书籍"按钮进行识别。');
    
    // 重置状态
    resetOpdsImportState();
    
    // 刷新主列表
    getDataFromApi();
};

const resetOpdsImportState = () => {
    opdsImportState.value = 'connecting';
    currentOpdsPath.value = '';
    opdsItems.value = [];
    selectedOpdsBooks.value = [];
    opdsConnection.value = null;
    opdsHost.value = '';
    opdsPort.value = '';
    opdsPath.value = '';
    opdsError.value = '';
    opdsLoading.value = false;
    opdsImportProgress.value = {
        done: 0,
        total: 0,
        percent: 0
    };
    opdsImportResult.value = {
        done: 0,
        fail: 0
    };
};

// 修改 scan_books 函数，添加OPDS书籍的提示
const scan_books = () => {
    loading.value = true;
    $backend('/admin/scan/run', {
        method: 'POST',
    }).then((rsp) => {
        if (rsp.err !== 'ok') {
            if ($alert) $alert('error', rsp.msg);
            return;
        }

        loop_check_status('/admin/scan/status', (rsp) => {
            scan_status.value = rsp.status;
            count_done.value = rsp.summary.done;
            count_todo.value = rsp.summary.todo;
            if (scan_status.value.new === 0) {
                loading.value = false;
                // 扫描完成后提示用户
                if (scan_status.value.new === 0 && scan_status.value.total > 0) {
                    $alert('success', '扫描完成！请查看"待处理"列表中的书籍。');
                }
                return false;
            }
            loading.value = true;
            return true;
        });
    });
};

onMounted(() => {
    getDataFromApi();
});

useHead({
    title: '导入图书'
});
</script>
```

## 3. 工作流程说明

现在的工作流程如下：

1. **选择OPDS书籍**：
   - 用户通过OPDS对话框选择要导入的书籍
   - 点击"导入选中书籍"

2. **下载并移动到扫描目录**：
   - 后端下载OPDS书籍到临时目录
   - 将文件移动到系统的扫描目录（如 `/data/books/imports/`）
   - 返回成功消息

3. **扫描书籍**：
   - 用户在主界面点击"扫描书籍"按钮
   - 系统扫描扫描目录，识别新添加的OPDS书籍
   - 这些书籍会出现在"待处理"列表中，状态为"new"或"ready"

4. **导入书籍**：
   - 用户在"待处理"列表中选择要导入的书籍
   - 点击"导入"按钮
   - 系统处理导入，成功后书籍状态变为"imported"
   - 已导入的书籍会显示在"已导入"列表中

## 4. 优点

1. **集成现有流程**：OPDS导入的书籍使用现有的扫描/导入流程
2. **状态清晰**：用户可以在"待处理"列表中看到所有等待导入的书籍
3. **进度可见**：导入进度在主界面的数据表中清晰可见
4. **错误处理**：如果OPDS导入失败，不会影响现有系统
5. **灵活性**：用户可以选择扫描哪些书籍，批量导入哪些书籍

这样，OPDS导入的书籍就能完美集成到现有的导入流程中，用户可以在统一的界面中管理所有导入任务。
